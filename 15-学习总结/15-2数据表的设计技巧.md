# 数据表的设计技巧

## 基本原则

##### 1. 职责分离原则

  在设计的时候应当考虑到数据的产生，聚合使用等原则，每个系统干自己能干的事情，每个系统只干自己的事情：明确如下几点：
 （1）谁产生这个信息，就由谁对此数据负责
 （2） 谁最经常使用这个信息，就由该系统来负责保存维护该数据
 （3）遵守高内聚，低耦合的考虑：

##### 2. 在线处理与分析分离原则

（1）为了保障线上数据处理的性能，将一些分析相关的数据及分析结果，应当使用单独的库来进行存储，避免在数据分析的时候导致业务数据吞吐量下降，引起系统问题。
 （2）专门用于存放离线报表数据，并提供线上数据查询方法，建议将统计结果，汇总的数据都从在线处理数据库中移走。

##### 3. 事务与日志分离原则

（1）用户生成内容和用户行为日志要分开。系统本身预设的数据，记录用户身份及与功能相关的数据，和用户的行为日志应当各自单独存储
 （2）行为日志，需要做分析处理，并且由于时效性不宜存储在MySQL中，后期维护就是地雷。

##### 4. 历史可追溯原则

  在数据库设计的时候为了保障数据是可追溯的，应当遵循一些简单的约定，事后方便数据的查询和统计：
 （1）对于状态数据，应当设计相应状态的字段来保存该数据的最后状态，同时记录下来该数据的初始创建人，时间以及该数据的最后修改人和修改时间；
 （2）针对需要跟踪每次修改的数据，需要在数据发生变化的时候记录一张日志表，用于记录该数据发生变化的全生命周期。针对只需要关注关键字段变化的情况，则日志表中只需要记录关键字段变化即可，但操作人，操作类型，时间应当准确记录，日志表数据一旦生成不允许进行修改。
 （3）针对所有历史需要保留的数据则需要每次变化都生成一个新的版本，比如类目信息等，对原始数据永远只做`insert`操作，不做`delete`及`update`操作。但这种情况仅限于极端数据历史要求极高的情况下使用。

## 表设计的建议

##### 1. 字段的原子性

  保证每列的原子性，字段含义言简意赅，高度概括。
  能用一个字段表达清楚的绝不使用第二个字段，须要使用两个字段表达清楚的绝不能使用一个字段

##### 2. 主键设计

  主键不要与业务逻辑有所关联，最好是毫无意义的一串独立不重复的数字
  例如：使用`UUID`，或者将主键设置为`AUTO_INCREMENT`
  根据数据库设计三大范式，尽量保证列数据和主键直接相关而不是间接相关

##### 3. 字段长度

  字段长度尽量要比实际业务的字段大3-5个字段左右（考虑到合理性和伸缩性）
  不要建比实际业务大太多的字段长度，，这是因为如果字段长度过大，在进行查询的时候索引在B-Tree树上遍历会越耗费时间，从而查询的时间会越久

##### 4. 关于外键

  尽量不要建立外键，保证每个表的独立性。如果非得保持一定的关系，最好是通过id进行关联

##### 5. 动静分离

  做好静态表和动态表的分离
  静态表：存储着一些固定不变的资源，比如城市/地区名/国家(静态表一定要使用缓存)。动态表：一些频繁修改的表

##### 6. 关于Null值

  尽量不要有null值，有null值的话，数据库在进行索引的时候查询的时间更久，从而浪费更多的时间！可以在建表的时候设置一个默认值！

##### 7. 预留表开关字段

  设计一个单一字段去控制表是否可用，如 `isValid: true/false`

##### 8. 删除字段

  数据库是禁止使用delete命令的,一般都不会真正删除数据，都是采用改状态的方式，设置state字段，通过修改状态赋予它是否有效的逻辑含义！

