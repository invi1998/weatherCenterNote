# 水平触发&边缘触发

- select和poll采用水平触发
- epoll有水平触发和边缘触发两种，默认是水平触发

## 水平触发

- 如果接收缓冲区不为空，表示有数据可读，如果数据没有被读取完。再次调用epoll_wait的时候，读事件一直触发
- 如果发送缓冲区没有满，表示可用写入数据，只要缓冲区没有写满，再次调用epoll_wait的时候，写事件一直触发

## 边缘触发

- socket加入epoll后，如果接收缓冲区不为空，触发可读事件，如果有新数据到达，再次触发可读事件
- epoll触发可读事件后，不管出有没有处理可读事件，epoll都不会再次触发，只有当新的数据到达后，才会再次触发可读事件
- socket加入epoll后，如果发送缓冲区不为空，触发可写事件，如果发送缓冲区由满变为有空时，再次触发可写事件

## IO复用一定要用非阻塞的IO

- 当数据达到socket缓冲区的时候，可能会因为某些原因被内核丢弃，比如校验和错误，这时候，如果采用了阻塞的IO，唤醒的程序读不到数据，accept和recv函数就会阻塞
- 到达缓冲区的数据可能会被别人取走，比如说多个进程accept同一个socket时引发的惊群现象，只有一个链接到来，但是所有的监听进程都被唤醒，最终只有一个进程可以accept到这个请求，其他的进程accept都会被阻塞
- ET(边缘触发)模式下，必须要使用非阻塞的IO，因为程序中需要循环读和写，直到EAGAN出现，如果使用功能阻塞IO容易被阻塞

## ET读的方法

- 如果接收缓冲区中有事件没有处理或者数据没有读完
- 水平触发：epoll_wait会重复报告，不必担心遗漏事件
- 边缘触发：epoll_wait不会重复报告，程序要用一个循环处理全部的事件或者读取全部的数据

## ET写的方法

- 想写就直接写，出现EAGAIN就别写了
- 水平触发：epoll_wait会重复报告，如果不想写了，可以注销事件。
- 边缘触发：epoll_wait不会重复报告，不想写了就不写，不必注销事件

