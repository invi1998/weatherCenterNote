# 数据入库子程序

## 解析入库参数

```c++
// 业务处理主函数
bool _xmltodb()
{
    // 把数据入库的参数配置文件starg.inifilename加载到容器中

    while (true)
    {
        // 打开starg.xmlpath目录

        
        // 遍历目录中的文件名
        while(true)
        {
            // 读取目录，得到一个xml文件

            // 处理xml文件
            // 调用文件处理子函数

            // 处理xml文件成功，写日志，备份文件

            // 处理文件失败。分情况讨论
        }

        sleep(starg.timetvl);
    }
    

    return true;
}
```

## xml入库主流程

```c++
// xml文件入库主函数，返回值 0 - 成功，其他都是失败，失败的情况有很多
int _xmltodb(char *fullfilename, char *filename)
{
    // 先从vxmltotable容器中查找filename的入库参数，存放在stxmltotable容器中
    if(findxmltotable(filename) == false) return 1;

    // 处理文件之前，先查询mysql的数据字典，把表的字段信息拿出来（获取表全部的字段和主键信息）


    // 有了表的字段和主键信息，就可以拼接生成插入和更新表数据的sql

    // prepare插入和更新的sql语句，绑定输入变量

    // 在处理xml文件之前，如果stxmltotable.execsql不为空，就执行它

    // 打开xml文件

    while (true)
    {
        // 从xml文件中读取一行

        // 解析xml，存放在已经绑定的输入变量中

        // 执行插入和更新的sql
    }
    

    return 0;
}
```

## 关于查找数据字典

```mysql
mysql> desc information_schema.COLUMNS;
+--------------------------+---------------------+------+-----+---------+-------+
| Field                    | Type                | Null | Key | Default | Extra |
+--------------------------+---------------------+------+-----+---------+-------+
| TABLE_CATALOG            | varchar(512)        | NO   |     |         |       |
| TABLE_SCHEMA             | varchar(64)         | NO   |     |         |       |
| TABLE_NAME               | varchar(64)         | NO   |     |         |       |
| COLUMN_NAME              | varchar(64)         | NO   |     |         |       |
| ORDINAL_POSITION         | bigint(21) unsigned | NO   |     | 0       |       |
| COLUMN_DEFAULT           | longtext            | YES  |     | NULL    |       |
| IS_NULLABLE              | varchar(3)          | NO   |     |         |       |
| DATA_TYPE                | varchar(64)         | NO   |     |         |       |
| CHARACTER_MAXIMUM_LENGTH | bigint(21) unsigned | YES  |     | NULL    |       |
| CHARACTER_OCTET_LENGTH   | bigint(21) unsigned | YES  |     | NULL    |       |
| NUMERIC_PRECISION        | bigint(21) unsigned | YES  |     | NULL    |       |
| NUMERIC_SCALE            | bigint(21) unsigned | YES  |     | NULL    |       |
| DATETIME_PRECISION       | bigint(21) unsigned | YES  |     | NULL    |       |
| CHARACTER_SET_NAME       | varchar(32)         | YES  |     | NULL    |       |
| COLLATION_NAME           | varchar(32)         | YES  |     | NULL    |       |
| COLUMN_TYPE              | longtext            | NO   |     | NULL    |       |
| COLUMN_KEY               | varchar(3)          | NO   |     |         |       |
| EXTRA                    | varchar(30)         | NO   |     |         |       |
| PRIVILEGES               | varchar(80)         | NO   |     |         |       |
| COLUMN_COMMENT           | varchar(1024)       | NO   |     |         |       |
| GENERATION_EXPRESSION    | longtext            | NO   |     | NULL    |       |
+--------------------------+---------------------+------+-----+---------+-------+
21 rows in set (0.00 sec)

```

在mysql中，可以使用如上命令查找mysql的数据字典表的信息。其中，我们只需要重点关心 `TABLE_NAME（表名）`， `COLUMN_NAME（列名）`，`DATA_TYPE（数据类型）`，`CHARACTER_MAXIMUM_LENGTH（如果是字符串，还需要关注最大的长度）`这几个字段。

查询sql可以这样写,（数据库设计中，应该采用统一的命名方式，比如表名用大写，字段名用小写0）

```mysql
mysql> select lower(column_name),lower(data_type),character_maximum_length from information_schema.COLUMNS where table_name='T_ZHOBTMIND';
+--------------------+------------------+--------------------------+
| lower(column_name) | lower(data_type) | character_maximum_length |
+--------------------+------------------+--------------------------+
| obtid              | varchar          |                       10 |
| ddatetime          | datetime         |                     NULL |
| t                  | int              |                     NULL |
| p                  | int              |                     NULL |
| u                  | int              |                     NULL |
| wd                 | int              |                     NULL |
| wf                 | int              |                     NULL |
| r                  | int              |                     NULL |
| vis                | int              |                     NULL |
| upttime            | timestamp        |                     NULL |
| keyid              | bigint           |                     NULL |
+--------------------+------------------+--------------------------+
11 rows in set (0.00 sec)

```

