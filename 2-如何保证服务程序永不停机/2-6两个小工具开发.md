# 两个常用的小工具

- 开发压缩文件模块
- 开发清理历史数据文件模块

这两个工具都是常用的通用工具，所以放在tools目录下

## 开发压缩文件模块

开发思路：

>   // 编写程序的帮助
>
>   // 关闭全部信号和io(输入输出)
>
>   // 获取文件超时的时间点（本程序要压缩历史文件，历史文件怎么定义？）
>
>   // 这里可以认为一个小时之前的文件属于历史文件，或者认为3天之前的属于历史文件，这里总有一个时间点，这里我们就获取这个时间点
>
>   // 这个时间点，应该是由main函数的参数指定的
>
>   // 打开目录，CDir.OpenDir()。打开目录可以使用开发框架里这个CDir类的OpenDir方法来打开目录
>
>   // 然后就是遍历目录中的文件名
>
>   while(true)
>
>   {
>
> ​    // 在循环中调用 CDir.ReadDir()方法读取每个文件的信息（包括文件名，文件时间）
>
> ​    // 然后把文件的时间和超时时间点做比较，如果文件时间更早，就说明是一个历史文件，就需要进行压缩
>
> ​    // 压缩文件，调用操作系统的gzip命令压缩文件
>
>   }

### 程序帮助

首先我们先看一下这个帮助

```c++
    if(argc != 4)
    {
        printf("\n");
        printf("Using:/project/tools1/bin/gzipfiles pathname matchstr timeout\n\n");

        printf("Example:/project/tools1/bin/gzipfiles /log/idc \"*.log.20*\" 0.02\n");
        printf("        /project/tools1/bin/gzipfiles /tmp/idc/surfdata \"*.xml,*.json\" 0.01\n");
        printf("        /project/tools1/bin/procctl 300 /project/tools1/bin/gzipfiles /log/idc \"*.log.20*\" 0.02\n");
        printf("        /project/tools1/bin/procctl 300 /project/tools1/bin/gzipfiles /tmp/idc/surfdata \"*.xml,*.json\" 0.01\n\n");

        printf("这是一个工具程序，用于压缩历史的数据文件或日志文件。\n");
        printf("本程序把pathname目录及子目录中timeout天之前的匹配matchstr文件全部压缩，timeout可以是小数。\n");
        printf("本程序不写日志文件，也不会在控制台输出任何信息。\n");
        printf("本程序调用/usr/bin/gzip命令压缩文件。\n\n\n");

        return -1;
    }
```

这里这个程序需要3个参数，psthname指定了扫描的目录，然后matchstr 表示需要处理该目录下的什么文件。timeout是一个时间点，在这个时间点之前的文件会被压缩

看第一个例子：

`/project/tools1/bin/gzipfiles /log/idc \"*.log.20*\" 0.02`

这个例子就表示运行程序，压缩 `/log/idc`这个目录下，匹配 `*.log.20*`的，0.02天之前的文件。

为什么要使用双引号将这个matchstr包起来呢？是因为这个参数它有特殊字符，特殊字符在这里就是这个 `*` ，在linux下，程序的参数如果有特殊字符，是需要使用双引号包起来，比如 `ls -lt`这个命令，`-lt`是他的参数，那么这里给他加上和这个双引号也是可以的，比如 `ls "-lt"`，不加也是可以的，只要记住，如果是存在特殊字符的参数，是需要使用双引号包起来的。然后在c/c++里，双引号做打印的时候，又需要做转义，这里要留意一下。

`/project/tools1/bin/gzipfiles /tmp/idc/surfdata \"*.xml,*.json\" 0.01`

然后看这个，这个程序运行的意思就是将 `/tmp/idc/surfdata`目录下0.01天以前的，以xml和json结尾的文件给删除，这里没什么好讲的，只是要注意一点，就是如果规则中有多个需要匹配的规则，那么规则之间需要使用 `,`分割。

`/project/tools1/bin/procctl 300 /project/tools1/bin/gzipfiles /log/idc \"*.log.20*\" 0.02`

这个表示这个程序需要使用调度程序 `/project/tools1/bin/procctl`来启动

### 关闭IO和信号

```c++
    // 关闭全部信号和io(输入输出)
    // 设置信号,在shell状态下可用 "kill + 进程号" 正常终止些进程。
    // 但请不要用 "kill -9 +进程号" 强行终止。
    CloseIOAndSignal(true);
    signal(SIGINT, EXIT);
    signal(SIGTERM, EXIT);
```

但是在开发阶段，这里io先暂时不关闭，方便调试

### 获取文件超时的时间点

这里我们使用一个字符串来存放这个时间点